<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBPJLEbi2a7d2Z-otz-TdiBc1cpDnfAeEs",
    authDomain: "challenge-21-days.firebaseapp.com",
    projectId: "challenge-21-days",
    storageBucket: "challenge-21-days.appspot.com",
    messagingSenderId: "470461590812",
    appId: "1:470461590812:web:9e06d8a2e2b545f66b5ed9",
    measurementId: "G-JTNJ525GC3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const calendar = document.getElementById("calendar");
  const congratsMessage = document.getElementById("congratsMessage");

  let userId = localStorage.getItem("challengeUserId");
  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem("challengeUserId", userId);
  }

  async function loadData() {
    const docRef = doc(db, "challenge", userId);
    const docSnap = await getDoc(docRef);
    let data = {};

    // If no data exists, create default unchecked days
    if (docSnap.exists()) {
      data = docSnap.data();
    } else {
      for (let i = 1; i <= 21; i++) {
        data[`day${i}`] = false;
      }
      await setDoc(docRef, data);
    }

    calendar.innerHTML = ""; // Clear existing

    for (let i = 1; i <= 21; i++) {
      const isChecked = data[`day${i}`] === true;
      const dayDiv = document.createElement("div");
      dayDiv.className = "day";
      dayDiv.innerHTML = `
        Day ${i}<br>
        <input type="checkbox" id="day${i}" ${isChecked ? "checked" : ""} onchange="checkChallenge()">
      `;
      calendar.appendChild(dayDiv);
    }

    checkChallenge();
  }

  window.checkChallenge = async function () {
    let streak = 0;
    let state = {};

    for (let i = 1; i <= 21; i++) {
      const checkbox = document.getElementById(`day${i}`);
      const checked = checkbox.checked;
      state[`day${i}`] = checked;
      if (checked) {
        streak++;
      } else {
        streak = 0;
      }
    }

    if (streak === 21) {
      congratsMessage.style.display = "block";
    } else {
      congratsMessage.style.display = "none";
    }

    await setDoc(doc(db, "challenge", userId), state);
  };

  window.resetChallenge = async function () {
    const blankState = {};
    for (let i = 1; i <= 21; i++) {
      blankState[`day${i}`] = false;
    }

    // Update UI
    for (let i = 1; i <= 21; i++) {
      const checkbox = document.getElementById(`day${i}`);
      if (checkbox) checkbox.checked = false;
    }

    congratsMessage.style.display = "none";
    await setDoc(doc(db, "challenge", userId), blankState);
  };

  window.onload = loadData;
</script>
